#!/bin/bash
# Pre-commit security checklist
# Install: git config core.hooksPath .githooks

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo "üîê Running pre-commit security checks..."

FAILED=0

# 1. Scan staged files for credential patterns
echo -n "  Checking for credentials... "
PATTERNS='(sk-[a-zA-Z0-9]{20,}|sk_live_[a-zA-Z0-9]+|ghp_[a-zA-Z0-9]{36}|xox[pbar]-[a-zA-Z0-9-]+|AKIA[0-9A-Z]{16}|password\s*=\s*["\x27][^"\x27]+["\x27]|api_key\s*=\s*["\x27][^"\x27]+["\x27])'

STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(py|js|ts|json|yaml|yml|env|toml|cfg|ini)$' || true)

if [ -n "$STAGED_FILES" ]; then
    MATCHES=$(echo "$STAGED_FILES" | xargs grep -lE "$PATTERNS" 2>/dev/null || true)
    if [ -n "$MATCHES" ]; then
        echo -e "${RED}FOUND${NC}"
        echo -e "${RED}    Potential credentials in:${NC}"
        echo "$MATCHES" | sed 's/^/      /'
        FAILED=1
    else
        echo -e "${GREEN}OK${NC}"
    fi
else
    echo -e "${GREEN}OK${NC} (no text files staged)"
fi

# 2. Check for sensitive paths being committed
echo -n "  Checking for sensitive paths... "
SENSITIVE_PATTERNS='(\.env$|\.env\.|node_modules/|\.next/|__pycache__|\.venv/|dist/|\.sst$)'
BAD_PATHS=$(git diff --cached --name-only | grep -E "$SENSITIVE_PATTERNS" || true)

if [ -n "$BAD_PATHS" ]; then
    echo -e "${RED}FOUND${NC}"
    echo -e "${RED}    Sensitive files staged:${NC}"
    echo "$BAD_PATHS" | sed 's/^/      /'
    FAILED=1
else
    echo -e "${GREEN}OK${NC}"
fi

# 3. Check for large files (potential cache/artifact leak)
echo -n "  Checking for large files (>1MB)... "
LARGE_FILES=$(git diff --cached --name-only | while read f; do
    if [ -f "$f" ]; then
        SIZE=$(stat -f%z "$f" 2>/dev/null || stat -c%s "$f" 2>/dev/null || echo 0)
        if [ "$SIZE" -gt 1048576 ]; then
            echo "$f ($(numfmt --to=iec $SIZE 2>/dev/null || echo "${SIZE}B"))"
        fi
    fi
done)

if [ -n "$LARGE_FILES" ]; then
    echo -e "${YELLOW}WARNING${NC}"
    echo -e "${YELLOW}    Large files (review before commit):${NC}"
    echo "$LARGE_FILES" | sed 's/^/      /'
else
    echo -e "${GREEN}OK${NC}"
fi

# 4. Check for private keys (hex format)
echo -n "  Checking for private keys... "
if [ -n "$STAGED_FILES" ]; then
    PRIVKEY_MATCHES=$(echo "$STAGED_FILES" | xargs grep -lE '(0x)?[a-fA-F0-9]{64}' 2>/dev/null | grep -v '\.lock$' || true)
    # Filter out known false positives (contract addresses, hashes in comments)
    if [ -n "$PRIVKEY_MATCHES" ]; then
        # Double-check: look for actual key assignments
        REAL_KEYS=$(echo "$PRIVKEY_MATCHES" | xargs grep -lE '(private_key|PRIVATE_KEY|secret|SECRET)\s*[=:]\s*["\x27]?(0x)?[a-fA-F0-9]{64}' 2>/dev/null || true)
        if [ -n "$REAL_KEYS" ]; then
            echo -e "${RED}FOUND${NC}"
            echo -e "${RED}    Potential private keys in:${NC}"
            echo "$REAL_KEYS" | sed 's/^/      /'
            FAILED=1
        else
            echo -e "${GREEN}OK${NC}"
        fi
    else
        echo -e "${GREEN}OK${NC}"
    fi
else
    echo -e "${GREEN}OK${NC}"
fi

if [ $FAILED -eq 1 ]; then
    echo ""
    echo -e "${RED}‚ùå Pre-commit checks failed. Fix issues above or use --no-verify to bypass.${NC}"
    exit 1
fi

echo -e "${GREEN}‚úÖ All security checks passed${NC}"
